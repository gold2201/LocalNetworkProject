<!-- templates/networks.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Сети - Локальная компьютерная сеть{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap5.min.css">
<style>
.network-status {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 5px;
}
.network-active { background-color: #28a745; }
.network-inactive { background-color: #dc3545; }
.network-warning { background-color: #ffc107; }
.table-actions .btn { margin-right: 5px; }
#loading-row { display: none; }
.vlan-badge {
    background-color: #6f42c1;
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-weight: bold;
}
</style>
{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-3">
            <div class="col-12">
                <h1><i class="bi bi-diagram-3"></i> Управление сетями</h1>
                <p class="lead">Просмотр и управление сетевыми подключениями</p>
            </div>
        </div>

        <!-- Статистика -->
        <div class="row mb-4" id="statistics-row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body py-2">
                        <div class="row text-center">
                            <div class="col-md-2 col-6">
                                <h5 class="mb-0" id="total-networks">0</h5>
                                <small class="text-muted">Всего сетей</small>
                            </div>
                            <div class="col-md-2 col-6">
                                <h5 class="mb-0" id="total-computers">0</h5>
                                <small class="text-muted">Компьютеров</small>
                            </div>
                            <div class="col-md-2 col-6">
                                <h5 class="mb-0" id="avg-vlan">0</h5>
                                <small class="text-muted">Средний VLAN</small>
                            </div>
                            <div class="col-md-2 col-6">
                                <h5 class="mb-0" id="networks-with-equipment">0</h5>
                                <small class="text-muted">С оборудованием</small>
                            </div>
                            <div class="col-md-4 col-12 mt-md-0 mt-2">
                                <div class="d-flex justify-content-center">
                                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="loadStatistics()">
                                        <i class="bi bi-arrow-clockwise"></i> Обновить
                                    </button>
                                    <button class="btn btn-sm btn-info" onclick="showStatisticsModal()">
                                        <i class="bi bi-graph-up"></i> Подробная статистика
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Фильтры и действия -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <input type="number" id="vlanFilter" class="form-control" placeholder="VLAN...">
                            </div>
                            <div class="col-md-3">
                                <input type="text" id="ipRangeFilter" class="form-control" placeholder="Диапазон IP...">
                            </div>
                            <div class="col-md-2">
                                <select id="equipmentFilter" class="form-select">
                                    <option value="">Все оборудование</option>
                                    <option value="Router">Роутер</option>
                                    <option value="Switch">Свитч</option>
                                    <option value="Firewall">Фаервол</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select id="hasComputersFilter" class="form-select">
                                    <option value="">Все сети</option>
                                    <option value="true">С компьютерами</option>
                                    <option value="false">Без компьютеров</option>
                                </select>
                            </div>
                            <div class="col-md-2 d-flex gap-2">
                                <button class="btn btn-primary flex-fill" onclick="loadNetworks()">
                                    <i class="bi bi-search"></i> Поиск
                                </button>
                                <button class="btn btn-outline-secondary" onclick="resetFilters()" title="Сбросить">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-8">
                                <input type="text" id="searchFilter" class="form-control" placeholder="Поиск по VLAN, IP, оборудованию...">
                            </div>
                            <div class="col-md-4 d-flex gap-2">
                                <button class="btn export-btn flex-fill" onclick="exportNetworks()">
                                    <i class="bi bi-download"></i> Экспорт
                                </button>
                                <button class="btn btn-success" onclick="showExportOptions()">
                                    <i class="bi bi-gear"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Таблица сетей -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Список сетей</h5>
                        <div class="d-flex align-items-center">
                            <span class="me-3 text-muted" id="total-count">Загрузка...</span>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-secondary" onclick="refreshTable()">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table id="networksTable" class="table table-striped table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th width="100">VLAN</th>
                                        <th width="200">Диапазон IP</th>
                                        <th>Маска подсети</th>
                                        <th>Оборудование</th>
                                        <th width="100">Портов</th>
                                        <th width="120">Компьютеры</th>
                                        <th width="150" class="text-end">Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="networks-body">
                                    <tr id="loading-row">
                                        <td colspan="7" class="text-center py-5">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Загрузка...</span>
                                            </div>
                                            <p class="mt-2 text-muted">Загрузка данных...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="dataTables_info" id="pagination-info">Загрузка...</div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex justify-content-end">
                                    <nav id="pagination-controls">
                                        <!-- Пагинация загружается динамически -->
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для просмотра деталей -->
<div class="modal fade" id="networkDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-diagram-3 me-2"></i>Детали сети
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="network-detail-content">
                    <!-- Содержимое загружается динамически -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" onclick="printNetworkDetails()">
                    <i class="bi bi-printer"></i> Печать
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно статистики -->
<div class="modal fade" id="statisticsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="bi bi-graph-up me-2"></i>Статистика сетей
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="statistics-content">
                    <!-- Статистика загружается динамически -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно компьютеров в сети -->
<div class="modal fade" id="networkComputersModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-pc-display me-2"></i>Компьютеры в сети
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="network-computers-content">
                    <!-- Содержимое загружается динамически -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/responsive.bootstrap5.min.js"></script>
<script>
// Глобальные переменные
let networks = [];
let currentPage = 1;
let totalPages = 1;
let pageSize = 25;
let dataTable = null;

$(document).ready(function() {
    loadStatistics();
    loadNetworks();
    setupEventListeners();
});

function setupEventListeners() {
    // Поиск по Enter
    $('#searchFilter').on('keypress', function(e) {
        if (e.which === 13) loadNetworks();
    });

    // Автоматический поиск при изменении фильтров (с задержкой)
    let searchTimer;
    $('#vlanFilter, #ipRangeFilter, #equipmentFilter, #hasComputersFilter').on('change', function() {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(loadNetworks, 500);
    });
}

function loadStatistics() {
    $.get('/api/networks/statistics/', function(data) {
        $('#total-networks').text(data.total_networks || 0);
        $('#total-computers').text(data.total_computers_connected || 0);
        $('#avg-vlan').text(Math.round(data.average_vlan || 0));
        $('#networks-with-equipment').text(data.networks_with_equipment || 0);
    }).fail(function(xhr) {
        console.error('Ошибка загрузки статистики:', xhr);
    });
}

function loadNetworks(page = 1) {
    showLoading(true);
    currentPage = page;

    const params = new URLSearchParams({
        page: page,
        page_size: pageSize
    });

    // Фильтры
    const vlan = $('#vlanFilter').val();
    const ipRange = $('#ipRangeFilter').val();
    const equipmentType = $('#equipmentFilter').val();
    const hasComputers = $('#hasComputersFilter').val();
    const search = $('#searchFilter').val();

    if (vlan) params.append('vlan', vlan);
    if (ipRange) params.append('ip_range', ipRange);
    if (equipmentType) params.append('equipment_type', equipmentType);
    if (hasComputers) params.append('has_computers', hasComputers);
    if (search) params.append('search', search);

    const url = `/api/networks/?${params.toString()}`;

    $.get(url)
        .done(function(data) {
            networks = data.results || [];
            totalPages = Math.ceil((data.count || 0) / pageSize);
            renderNetworks(data);
            updatePagination(data);
            updateTableInfo(data);
        })
        .fail(function(xhr) {
            showAlert(`Ошибка загрузки: ${xhr.responseJSON?.detail || 'Неизвестная ошибка'}`, 'danger');
        })
        .always(function() {
            showLoading(false);
        });
}

function showLoading(show) {
    $('#loading-row').toggle(show);
    if (show) {
        $('#networks-body').children().not('#loading-row').hide();
    } else {
        $('#networks-body').children().not('#loading-row').show();
    }
}

function renderNetworks(data) {
    const tbody = $('#networks-body');
    tbody.children().not('#loading-row').remove();

    if (!networks.length) {
        tbody.append(`
            <tr>
                <td colspan="7" class="text-center py-4">
                    <i class="bi bi-info-circle display-6 text-muted mb-3"></i>
                    <p class="h5 text-muted">Сети не найдены</p>
                    <p class="text-muted">Попробуйте изменить параметры фильтрации</p>
                </td>
            </tr>
        `);
        return;
    }

    networks.forEach(network => {
        const computerCount = network.computers_count || 0;
        const portCount = network.equipment?.port_count || 'Н/Д';
        const equipmentType = network.equipment?.type || 'Не указано';
        const bandwidth = network.equipment?.bandwidth ? `${network.equipment.bandwidth} Мбит/с` : 'Н/Д';

        tbody.append(`
            <tr data-network-id="${network.id}">
                <td>
                    <span class="vlan-badge">${network.vlan}</span>
                </td>
                <td>
                    <strong>${network.ip_range}</strong>
                    <div class="small text-muted">${network.subnet_mask}</div>
                </td>
                <td>${network.subnet_mask}</td>
                <td>
                    <div><strong>${equipmentType}</strong></div>
                    <div class="small text-muted">${bandwidth}</div>
                </td>
                <td>
                    <span class="badge bg-secondary">${portCount}</span>
                </td>
                <td>
                    <span class="badge ${computerCount > 0 ? 'bg-success' : 'bg-warning'}">
                        ${computerCount}
                    </span>
                    ${computerCount > 0 ? `
                    <button class="btn btn-sm btn-link p-0 ms-1" onclick="viewNetworkComputers(${network.id})"
                            title="Показать компьютеры">
                        <i class="bi bi-list"></i>
                    </button>` : ''}
                </td>
                <td class="text-end">
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-info" onclick="viewNetworkDetails(${network.id})"
                                title="Детали">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshNetwork(${network.id})"
                                title="Обновить">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `);
    });
}

function updatePagination(data) {
    const pagination = $('#pagination-controls');
    pagination.empty();

    if (totalPages <= 1) return;

    let html = '<ul class="pagination pagination-sm mb-0">';

    // Предыдущая страница
    html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadNetworks(${currentPage - 1})">Назад</a>
    </li>`;

    // Страницы
    for (let i = 1; i <= Math.min(totalPages, 5); i++) {
        html += `<li class="page-item ${currentPage === i ? 'active' : ''}">
            <a class="page-link" href="#" onclick="loadNetworks(${i})">${i}</a>
        </li>`;
    }

    // Многоточие если страниц больше 5
    if (totalPages > 5) {
        html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        html += `<li class="page-item">
            <a class="page-link" href="#" onclick="loadNetworks(${totalPages})">${totalPages}</a>
        </li>`;
    }

    // Следующая страница
    html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadNetworks(${currentPage + 1})">Вперед</a>
    </li>`;

    html += '</ul>';
    pagination.html(html);
}

function updateTableInfo(data) {
    const total = data.count || 0;
    const start = ((currentPage - 1) * pageSize) + 1;
    const end = Math.min(currentPage * pageSize, total);

    let info = `Показано ${start}-${end} из ${total} записей`;
    if (total === 0) {
        info = 'Нет данных для отображения';
    }

    $('#pagination-info').text(info);
    $('#total-count').text(`Всего: ${total}`);
}

function viewNetworkDetails(id) {
    showLoadingModal();

    $.get(`/api/networks/${id}/details/`)
        .done(function(network) {
            let content = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Основная информация</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tr><th width="40%">VLAN:</th><td><span class="vlan-badge">${network.vlan}</span></td></tr>
                                    <tr><th>Диапазон IP:</th><td>${network.ip_range}</td></tr>
                                    <tr><th>Маска подсети:</th><td>${network.subnet_mask}</td></tr>
                                    <tr><th>Подключено компьютеров:</th>
                                        <td><span class="badge ${network.connected_computers_count > 0 ? 'bg-success' : 'bg-warning'}">
                                            ${network.connected_computers_count}
                                        </span></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="bi bi-hdd-rack me-2"></i>Оборудование</h6>
                            </div>
                            <div class="card-body">
            `;

            if (network.equipment_info.type) {
                content += `
                    <table class="table table-sm">
                        <tr><th>Тип:</th><td>${network.equipment_info.type}</td></tr>
                        <tr><th>Пропускная способность:</th><td>${network.equipment_info.bandwidth} Мбит/с</td></tr>
                        <tr><th>Количество портов:</th><td>${network.equipment_info.port_count}</td></tr>
                        <tr><th>Дата установки:</th><td>${new Date(network.equipment_info.setup_date).toLocaleDateString()}</td></tr>
                    </table>
                `;
            } else {
                content += `<p class="text-muted mb-0">Оборудование не назначено</p>`;
            }

            content += `</div></div></div></div>`;

            // Последние подключенные компьютеры
            if (network.recent_computers && network.recent_computers.length > 0) {
                content += `
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="bi bi-pc-display me-2"></i>Недавно подключенные компьютеры</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Модель</th>
                                                    <th>Серийный номер</th>
                                                    <th>IP адрес</th>
                                                    <th>Скорость</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                `;

                network.recent_computers.forEach(computer => {
                    content += `
                        <tr>
                            <td>${computer.model}</td>
                            <td>${computer.serial_number}</td>
                            <td><code>${computer.ip_address}</code></td>
                            <td>${computer.speed} Мбит/с</td>
                        </tr>
                    `;
                });

                content += `</tbody></table></div>`;

                if (network.connected_computers_count > 5) {
                    content += `
                        <div class="text-center mt-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewNetworkComputers(${id})">
                                Показать все компьютеры (${network.connected_computers_count})
                            </button>
                        </div>
                    `;
                }

                content += `</div></div></div></div>`;
            }

            $('#network-detail-content').html(content);
            $('#networkDetailModal').modal('show');
        })
        .fail(function(xhr) {
            showAlert(`Ошибка загрузки деталей: ${xhr.responseJSON?.detail || 'Неизвестная ошибка'}`, 'danger');
        })
        .always(function() {
            hideLoadingModal();
        });
}

function viewNetworkComputers(id) {
    showLoadingModal();

    $.get(`/api/networks/${id}/computers/`)
        .done(function(data) {
            const computers = data.results || data;
            let content = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Компьютер</th>
                                <th>IP адрес</th>
                                <th>MAC адрес</th>
                                <th>Скорость</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            if (computers.length === 0) {
                content += `
                    <tr>
                        <td colspan="5" class="text-center text-muted py-3">
                            Нет подключенных компьютеров
                        </td>
                    </tr>
                `;
            } else {
                computers.forEach(computer => {
                    content += `
                        <tr>
                            <td>
                                <strong>${computer.computer_model}</strong>
                                ${computer.computer?.serial_number ? `<div class="small text-muted">SN: ${computer.computer.serial_number}</div>` : ''}
                            </td>
                            <td><code>${computer.ip_address}</code></td>
                            <td><code>${computer.mac_address}</code></td>
                            <td><span class="badge bg-info">${computer.speed} Мбит/с</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-info"
                                        onclick="window.location.href='/computers/${computer.computer}/'">
                                    <i class="bi bi-box-arrow-up-right"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }

            content += `</tbody></table></div>`;

            if (data.count && data.count > 10) {
                content += `
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle me-2"></i>
                        Показано ${computers.length} из ${data.count} компьютеров
                    </div>
                `;
            }

            $('#network-computers-content').html(content);
            $('#networkComputersModal').modal('show');
        })
        .fail(function(xhr) {
            showAlert(`Ошибка загрузки компьютеров: ${xhr.responseJSON?.detail || 'Неизвестная ошибка'}`, 'danger');
        })
        .always(function() {
            hideLoadingModal();
        });
}

function showStatisticsModal() {
    $.get('/api/networks/statistics/')
        .done(function(data) {
            let content = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Основные показатели</h6>
                                <table class="table table-sm">
                                    <tr><td>Всего сетей:</td><td class="text-end"><strong>${data.total_networks}</strong></td></tr>
                                    <tr><td>Подключено компьютеров:</td><td class="text-end"><strong>${data.total_computers_connected}</strong></td></tr>
                                    <tr><td>Средний VLAN:</td><td class="text-end"><strong>${Math.round(data.average_vlan)}</strong></td></tr>
                                    <tr><td>Максимальный VLAN:</td><td class="text-end"><strong>${data.max_vlan}</strong></td></tr>
                                    <tr><td>С оборудованием:</td><td class="text-end"><strong>${data.networks_with_equipment}</strong></td></tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Распределение по VLAN</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr><th>VLAN</th><th class="text-end">Количество</th></tr>
                                        </thead>
                                        <tbody>
            `;

            if (data.vlan_distribution && data.vlan_distribution.length > 0) {
                data.vlan_distribution.forEach(item => {
                    content += `
                        <tr>
                            <td>${item.vlan}</td>
                            <td class="text-end">${item.count}</td>
                        </tr>
                    `;
                });
            } else {
                content += `<tr><td colspan="2" class="text-center text-muted">Нет данных</td></tr>`;
            }

            content += `</tbody></table></div></div></div></div>`;

            $('#statistics-content').html(content);
            $('#statisticsModal').modal('show');
        })
        .fail(function(xhr) {
            showAlert('Ошибка загрузки статистики', 'danger');
        });
}

function resetFilters() {
    $('#vlanFilter').val('');
    $('#ipRangeFilter').val('');
    $('#equipmentFilter').val('');
    $('#hasComputersFilter').val('');
    $('#searchFilter').val('');
    loadNetworks(1);
}

function refreshTable() {
    loadNetworks(currentPage);
}

function refreshNetwork(id) {
    $.get(`/api/networks/${id}/`)
        .done(function() {
            showAlert('Данные сети обновлены', 'success');
            loadNetworks(currentPage);
        })
        .fail(function(xhr) {
            showAlert('Ошибка обновления', 'danger');
        });
}

function exportNetworks() {
    const params = new URLSearchParams();
    const vlan = $('#vlanFilter').val();
    const ipRange = $('#ipRangeFilter').val();

    if (vlan) params.append('vlan', vlan);
    if (ipRange) params.append('ip_range', ipRange);

    const url = `/api/networks/export/?${params.toString()}`;
    window.open(url, '_blank');
}

function showExportOptions() {
    // Можно добавить расширенные опции экспорта
    exportNetworks();
}

function printNetworkDetails() {
    const printContent = $('#network-detail-content').html();
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Детали сети</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    body { padding: 20px; }
                    @media print {
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                ${printContent}
                <div class="no-print text-center mt-4">
                    <button onclick="window.print()" class="btn btn-primary">Печать</button>
                    <button onclick="window.close()" class="btn btn-secondary">Закрыть</button>
                </div>
            </body>
        </html>
    `);
    printWindow.document.close();
}

function showLoadingModal() {
    $('#network-detail-content').html(`
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
            <p class="mt-2 text-muted">Загрузка данных...</p>
        </div>
    `);
}

function hideLoadingModal() {
    // Автоматически скрывается при загрузке данных
}

function showAlert(message, type) {
    const alert = $(`
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);

    // Удаляем старые алерты
    $('.alert-dismissible').remove();

    // Добавляем новый
    $('.container-fluid').prepend(alert);

    // Автоматическое закрытие
    setTimeout(() => {
        alert.alert('close');
    }, 5000);
}
</script>
{% endblock %}