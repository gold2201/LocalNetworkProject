<!-- templates/software.html -->
{% extends 'base.html' %}

{% block title %}ПО - Локальная компьютерная сеть{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1><i class="bi bi-motherboard"></i> Управление программным обеспечением</h1>
                <p class="lead">Добавление, редактирование и просмотр программного обеспечения</p>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- Фильтры и действия -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <input type="text" id="searchInput" class="form-control" placeholder="Поиск по названию или вендору...">
                        </div>
                        <div class="col-md-4">
                            <select id="licenseFilter" class="form-select">
                                <option value="">Все лицензии</option>
                                <option value="trial">Пробные</option>
                                <option value="commercial">Коммерческие</option>
                                <option value="free">Бесплатные</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary" onclick="loadSoftware()">
                                <i class="bi bi-search"></i> Применить
                            </button>
                            <button class="btn btn-secondary" onclick="resetFilters()">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                        <div class="col-md-2 text-end">
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#softwareModal">
                                <i class="bi bi-plus-circle"></i> Добавить
                            </button>
                            <button class="btn export-btn" onclick="exportSoftware()">
                                <i class="bi bi-download"></i> Экспорт
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Таблица ПО -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Список программного обеспечения</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="softwareTable" class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Название</th>
                                    <th>Версия</th>
                                    <th>Вендор</th>
                                    <th>Лицензия</th>
                                    <th>Установок</th>
                                    <th>Популярные ОС</th>
                                    <th>Требует обновления</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="software-body">
                                <!-- Данные загружаются через JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для добавления/редактирования -->
<div class="modal fade" id="softwareModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="softwareModalTitle">Добавить ПО</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="softwareForm">
                    <input type="hidden" id="softwareId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="name" class="form-label">Название *</label>
                            <input type="text" class="form-control" id="name" required>
                            <div class="invalid-feedback" id="nameError">Пожалуйста, введите название ПО</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="version" class="form-label">Версия *</label>
                            <input type="text" class="form-control" id="version" required>
                            <div class="invalid-feedback" id="versionError">Пожалуйста, введите версию</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="vendor" class="form-label">Вендор *</label>
                            <input type="text" class="form-control" id="vendor" required>
                            <div class="invalid-feedback" id="vendorError">Пожалуйста, введите вендора</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="license" class="form-label">Лицензия *</label>
                            <input type="text" class="form-control" id="license" required>
                            <div class="invalid-feedback" id="licenseError">Пожалуйста, введите лицензию</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveSoftware()">Сохранить</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let software = [];

// Получение CSRF токена для AJAX запросов
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

$(document).ready(function() {
    loadSoftware();
    initializeDataTable();
});

function initializeDataTable() {
    $('#softwareTable').DataTable({
        language: {
            url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/ru.json'
        },
        pageLength: 25
    });
}

function loadSoftware() {
    const search = $('#searchInput').val();
    const license = $('#licenseFilter').val();

    let url = '/api/software/';
    const params = [];
    if (search) params.push(`search=${encodeURIComponent(search)}`);
    if (license) params.push(`license_type=${license}`);

    if (params.length > 0) {
        url += '?' + params.join('&');
    }

    $.ajax({
        url: url,
        method: 'GET',
        success: function(data) {
            software = data.results || data;
            console.log('Loaded software:', software);
            renderSoftware();
        },
        error: function(xhr, status, error) {
            console.error('Error loading software:', error, xhr.responseText);
            showAlert('Ошибка при загрузке данных: ' + error, 'danger');
        }
    });
}

function renderSoftware() {
    const tbody = $('#software-body');
    tbody.empty();

    if (software.length === 0) {
        tbody.append(`
            <tr>
                <td colspan="8" class="text-center">Нет данных для отображения</td>
            </tr>
        `);
        return;
    }

    software.forEach(item => {
        const needsRenewal = item.needs_license_renewal ?
            '<span class="badge bg-danger">Да</span>' :
            '<span class="badge bg-success">Нет</span>';

        const popularOS = item.popular_os && item.popular_os.length > 0 ?
            item.popular_os.join(', ') :
            '<span class="text-muted">Нет данных</span>';

        const installedCount = item.installed_count || 0;

        tbody.append(`
            <tr>
                <td>${item.name || ''}</td>
                <td>${item.version || ''}</td>
                <td>${item.vendor || ''}</td>
                <td><span class="badge bg-info">${item.license || ''}</span></td>
                <td>
                    <span class="badge ${installedCount > 0 ? 'bg-primary' : 'bg-secondary'}">
                        ${installedCount}
                    </span>
                </td>
                <td>${popularOS}</td>
                <td>${needsRenewal}</td>
                <td class="table-actions">
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editSoftware(${item.id})"
                            title="Редактировать" data-bs-toggle="tooltip">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger me-1" onclick="showDeleteConfirm(${item.id})"
                            title="Удалить" data-bs-toggle="tooltip">
                        <i class="bi bi-trash"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="showCompatibleComputers(${item.id})"
                            title="Совместимые компьютеры" data-bs-toggle="tooltip">
                        <i class="bi bi-pc-display"></i>
                    </button>
                </td>
            </tr>
        `);
    });

    // Инициализация tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
}

function resetFilters() {
    $('#searchInput').val('');
    $('#licenseFilter').val('');
    loadSoftware();
}

function exportSoftware() {
    window.open('/api/software/export/', '_blank');
}

function editSoftware(id) {
    const item = software.find(s => s.id === id);
    if (item) {
        $('#softwareModalTitle').text('Редактировать ПО');
        $('#softwareId').val(item.id);
        $('#name').val(item.name);
        $('#version').val(item.version);
        $('#vendor').val(item.vendor);
        $('#license').val(item.license);

        $('#softwareModal').modal('show');
    }
}

function showCompatibleComputers(id) {
    // Загружаем список совместимых компьютеров
    $.ajax({
        url: `/api/software/${id}/compatible_computers/`,
        method: 'GET',
        success: function(data) {
            showComputersModal(data);
        },
        error: function(xhr) {
            showAlert('Ошибка загрузки списка компьютеров: ' + xhr.responseText, 'danger');
        }
    });
}

function showComputersModal(data) {
    let computersHtml = '';

    if (data.compatible_computers && data.compatible_computers.length > 0) {
        computersHtml = `
            <h6>${data.software}</h6>
            <p class="text-muted">Вендор: ${data.vendor}, Лицензия: ${data.license}</p>
            <p>Количество установок: <strong>${data.compatible_computers_count}</strong></p>

            <div class="table-responsive mt-3">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Модель</th>
                            <th>ОС</th>
                            <th>Отдел</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.compatible_computers.map(comp => `
                            <tr>
                                <td>${comp.id}</td>
                                <td>${comp.model}</td>
                                <td>${comp.os}</td>
                                <td>${comp.department__room_number || 'Не назначен'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } else {
        computersHtml = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                На данный момент нет компьютеров с установленным этим ПО.
            </div>
        `;
    }

    // Создаем или обновляем модальное окно
    if (!$('#computersModal').length) {
        $('body').append(`
            <div class="modal fade" id="computersModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Совместимые компьютеры</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="computersModalBody">
                            ${computersHtml}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                        </div>
                    </div>
                </div>
            </div>
        `);
    } else {
        $('#computersModalBody').html(computersHtml);
    }

    $('#computersModal').modal('show');
}

function showDeleteConfirm(id) {
    if (confirm('Вы уверены, что хотите удалить это ПО?')) {
        deleteSoftware(id);
    }
}

function deleteSoftware(id) {
    $.ajax({
        url: `/api/software/${id}/`,
        type: 'DELETE',
        headers: {
            'X-CSRFToken': csrftoken
        },
        success: function() {
            loadSoftware();
            showAlert('ПО успешно удалено', 'success');
        },
        error: function(xhr) {
            showAlert('Ошибка при удалении ПО: ' + xhr.responseText, 'danger');
        }
    });
}

function saveSoftware() {
    // Валидация формы
    let isValid = true;
    const requiredFields = ['name', 'version', 'vendor', 'license'];

    requiredFields.forEach(fieldId => {
        const field = $(`#${fieldId}`);
        if (!field.val().trim()) {
            field.addClass('is-invalid');
            isValid = false;
        } else {
            field.removeClass('is-invalid');
        }
    });

    if (!isValid) {
        showAlert('Пожалуйста, заполните все обязательные поля', 'warning');
        return;
    }

    const formData = {
        name: $('#name').val(),
        version: $('#version').val(),
        vendor: $('#vendor').val(),
        license: $('#license').val()
    };

    const softwareId = $('#softwareId').val();
    const url = softwareId ? `/api/software/${softwareId}/` : '/api/software/';
    const method = softwareId ? 'PUT' : 'POST';

    $.ajax({
        url: url,
        type: method,
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        },
        data: JSON.stringify(formData),
        success: function(response) {
            console.log('Success:', response);
            $('#softwareModal').modal('hide');
            loadSoftware();
            showAlert('ПО успешно сохранено', 'success');
        },
        error: function(xhr, status, error) {
            console.error('Error:', xhr.responseText);
            let errorMessage = 'Ошибка при сохранении ПО';
            try {
                const response = JSON.parse(xhr.responseText);
                if (typeof response === 'object') {
                    const errors = [];
                    for (const [key, value] of Object.entries(response)) {
                        if (Array.isArray(value)) {
                            errors.push(...value);
                        } else {
                            errors.push(value);
                        }
                    }
                    errorMessage += ': ' + errors.join(', ');
                } else {
                    errorMessage += ': ' + response;
                }
            } catch (e) {
                errorMessage += ': ' + xhr.statusText;
            }
            showAlert(errorMessage, 'danger');
        }
    });
}

function showAlert(message, type) {
    const alertId = 'alert-' + Date.now();
    const alertHtml = `
        <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" onclick="$('#${alertId}').alert('close')"></button>
        </div>
    `;

    $('#alert-container').append(alertHtml);

    setTimeout(() => {
        $(`#${alertId}`).alert('close');
    }, 5000);
}

// Открытие модального окна для добавления
$('#softwareModal').on('show.bs.modal', function() {
    $('#softwareModalTitle').text('Добавить ПО');
    $('#softwareForm')[0].reset();
    $('#softwareId').val('');
});
</script>
{% endblock %}